<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold/Silver Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
      min-height: 100vh;
      color: #e4e4e7;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    h1 { font-size: 1.8rem; display: flex; align-items: center; gap: 10px; }
    .last-update { font-size: 0.85rem; color: #71717a; }
    .refresh-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .refresh-btn:hover { background: rgba(255,255,255,0.2); }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .metal-card {
      position: relative;
      overflow: hidden;
    }
    .metal-card.gold { border-left: 4px solid #fbbf24; }
    .metal-card.silver { border-left: 4px solid #94a3b8; }
    
    .metal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    .metal-icon { font-size: 2.5rem; }
    .metal-name { font-size: 1.4rem; font-weight: 600; margin-top: 8px; }
    
    .price-main {
      font-size: 2.8rem;
      font-weight: 700;
      color: white;
    }
    .price-sub { font-size: 1rem; color: #a1a1aa; margin-top: 4px; }
    
    .change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .change.up { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .change.down { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .change.neutral { background: rgba(161, 161, 170, 0.2); color: #a1a1aa; }
    
    .advice-box {
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    .advice-box.buy { background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); }
    .advice-box.sell { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); }
    .advice-box.hold { background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.3); }
    
    .advice-label { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
    .advice-box.buy .advice-label { color: #22c55e; }
    .advice-box.sell .advice-label { color: #ef4444; }
    .advice-box.hold .advice-label { color: #fbbf24; }
    
    .confidence { font-size: 0.9rem; color: #a1a1aa; }
    .confidence-bar {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    .confidence-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
    .advice-box.buy .confidence-fill { background: #22c55e; }
    .advice-box.sell .confidence-fill { background: #ef4444; }
    .advice-box.hold .confidence-fill { background: #fbbf24; }
    
    .reasons {
      margin-top: 12px;
      text-align: left;
      font-size: 0.85rem;
      color: #a1a1aa;
    }
    .reasons li { margin: 4px 0; padding-left: 12px; position: relative; }
    .reasons li::before { content: '‚Ä¢'; position: absolute; left: 0; }
    
    .news-section { margin-top: 30px; }
    .news-section h2 { font-size: 1.3rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    
    .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px; }
    
    .news-item {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      transition: all 0.2s;
    }
    .news-item:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-2px); }
    .news-item a { color: inherit; text-decoration: none; }
    .news-title { font-weight: 600; margin-bottom: 8px; line-height: 1.4; }
    .news-meta { font-size: 0.8rem; color: #71717a; display: flex; justify-content: space-between; }
    
    .chart-container {
      margin-top: 16px;
      height: 60px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      padding: 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    .chart-bar {
      flex: 1;
      border-radius: 2px;
      min-height: 4px;
      transition: height 0.3s;
    }
    .gold .chart-bar { background: #fbbf24; }
    .silver .chart-bar { background: #94a3b8; }
    
    .disclaimer {
      margin-top: 30px;
      padding: 16px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      font-size: 0.85rem;
      color: #fca5a5;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      color: #71717a;
    }
    
    /* Portfolio Section */
    .portfolio-section {
      margin-bottom: 30px;
    }
    .portfolio-section h2 {
      font-size: 1.3rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .portfolio-card {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .portfolio-card.gold { border-left: 4px solid #fbbf24; }
    .portfolio-card.silver { border-left: 4px solid #94a3b8; }
    .portfolio-card.total { 
      border-left: 4px solid #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }
    .portfolio-label {
      font-size: 0.9rem;
      color: #a1a1aa;
      margin-bottom: 8px;
    }
    .portfolio-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
    .portfolio-input {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 12px 16px;
      color: white;
      font-size: 1.1rem;
      width: 100%;
    }
    .portfolio-input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.4);
    }
    .portfolio-input::placeholder { color: #71717a; }
    .portfolio-unit {
      color: #a1a1aa;
      font-size: 0.9rem;
      min-width: 50px;
    }
    .portfolio-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }
    .portfolio-value.gold-text { color: #fbbf24; }
    .portfolio-value.silver-text { color: #94a3b8; }
    .portfolio-value.total-text { color: #22c55e; }
    .portfolio-detail {
      font-size: 0.85rem;
      color: #a1a1aa;
      margin-top: 4px;
    }
    .portfolio-total-breakdown {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .breakdown-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    .breakdown-label { color: #a1a1aa; }
    .breakdown-value { color: white; }
    
    /* Crypto Section */
    .crypto-section {
      margin-top: 30px;
      margin-bottom: 30px;
    }
    .crypto-section h2 {
      font-size: 1.3rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .crypto-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .add-crypto-btn {
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.4);
      color: #a78bfa;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .add-crypto-btn:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.6);
    }
    .crypto-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .crypto-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      position: relative;
    }
    .crypto-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .crypto-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
    }
    .crypto-name {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .crypto-symbol {
      color: #a1a1aa;
      font-size: 0.85rem;
    }
    .crypto-price {
      font-size: 1.4rem;
      font-weight: 700;
      color: white;
      margin-bottom: 4px;
    }
    .crypto-change {
      font-size: 0.85rem;
      margin-bottom: 12px;
    }
    .crypto-change.up { color: #22c55e; }
    .crypto-change.down { color: #ef4444; }
    .crypto-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .crypto-input {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      padding: 8px 12px;
      color: white;
      font-size: 0.95rem;
    }
    .crypto-input:focus {
      outline: none;
      border-color: rgba(139, 92, 246, 0.5);
    }
    .crypto-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #a78bfa;
      margin-top: 8px;
    }
    .remove-crypto-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(239, 68, 68, 0.2);
      border: none;
      color: #ef4444;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      transition: all 0.2s;
    }
    .remove-crypto-btn:hover {
      background: rgba(239, 68, 68, 0.4);
    }
    
    /* Add Crypto Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #1a1a2e;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .modal h3 {
      margin-bottom: 20px;
      font-size: 1.3rem;
    }
    .modal-select {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 12px 16px;
      color: white;
      font-size: 1rem;
      margin-bottom: 16px;
      cursor: pointer;
    }
    .modal-select option {
      background: #1a1a2e;
      color: white;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      border: none;
    }
    .modal-btn.cancel {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .modal-btn.confirm {
      background: rgba(139, 92, 246, 0.8);
      color: white;
    }
    .modal-btn:hover { opacity: 0.9; }
    
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .news-grid { grid-template-columns: 1fr; }
      .price-main { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ü•á Gold/Silver Dashboard</h1>
        <div class="last-update" id="last-update">Loading...</div>
      </div>
      <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
    </header>
    
    <div class="portfolio-section">
      <h2>üí∞ My Portfolio</h2>
      <div class="portfolio-grid">
        <div class="portfolio-card gold">
          <div class="portfolio-label">ü•á Goud bezit</div>
          <div class="portfolio-input-group">
            <input type="number" class="portfolio-input" id="gold-amount" placeholder="0" min="0" step="0.1" onchange="updatePortfolio()">
            <span class="portfolio-unit">gram</span>
          </div>
          <div class="portfolio-value gold-text" id="gold-value">‚Ç¨ 0,00</div>
          <div class="portfolio-detail" id="gold-detail">0g √ó ‚Ç¨0,00/g</div>
        </div>
        
        <div class="portfolio-card silver">
          <div class="portfolio-label">ü•à Zilver bezit</div>
          <div class="portfolio-input-group">
            <input type="number" class="portfolio-input" id="silver-amount" placeholder="0" min="0" step="1" onchange="updatePortfolio()">
            <span class="portfolio-unit">gram</span>
          </div>
          <div class="portfolio-value silver-text" id="silver-value">‚Ç¨ 0,00</div>
          <div class="portfolio-detail" id="silver-detail">0g √ó ‚Ç¨0,00/g</div>
        </div>
        
        <div class="portfolio-card total">
          <div class="portfolio-label">üìä Totale waarde</div>
          <div class="portfolio-value total-text" id="total-value">‚Ç¨ 0,00</div>
          <div class="portfolio-total-breakdown">
            <div class="breakdown-row">
              <span class="breakdown-label">ü•á Goud</span>
              <span class="breakdown-value" id="breakdown-gold">‚Ç¨ 0,00</span>
            </div>
            <div class="breakdown-row">
              <span class="breakdown-label">ü•à Zilver</span>
              <span class="breakdown-value" id="breakdown-silver">‚Ç¨ 0,00</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="grid" id="prices">
      <div class="loading">Loading prices...</div>
    </div>
    
    <div class="crypto-section">
      <div class="crypto-header">
        <h2>ü™ô Crypto Portfolio</h2>
        <button class="add-crypto-btn" onclick="openAddCryptoModal()">
          ‚ûï Add Crypto
        </button>
      </div>
      <div class="crypto-grid" id="crypto-portfolio">
        <div class="loading" id="crypto-loading" style="display: none;">Loading crypto...</div>
      </div>
    </div>
    
    <!-- Add Crypto Modal -->
    <div class="modal-overlay" id="add-crypto-modal">
      <div class="modal">
        <h3>ü™ô Add Crypto to Portfolio</h3>
        <select class="modal-select" id="crypto-select">
          <option value="">Select a cryptocurrency...</option>
        </select>
        <div class="modal-buttons">
          <button class="modal-btn cancel" onclick="closeAddCryptoModal()">Cancel</button>
          <button class="modal-btn confirm" onclick="addSelectedCrypto()">Add</button>
        </div>
      </div>
    </div>
    
    <div class="news-section">
      <h2>üì∞ Latest News</h2>
      <div class="news-grid" id="news">
        <div class="loading">Loading news...</div>
      </div>
    </div>
    
    <div class="disclaimer">
      ‚ö†Ô∏è <strong>Disclaimer:</strong> This dashboard is for informational purposes only and does not constitute financial advice. 
      Always do your own research and consult with a qualified financial advisor before making investment decisions.
      Past performance is not indicative of future results.
    </div>
  </div>
  
  <script>
    let data = null
    let cryptoPortfolio = [] // Array of { id, symbol, name, amount, image }
    
    // Portfolio functions
    function loadPortfolio() {
      const saved = localStorage.getItem('metalPortfolio')
      if (saved) {
        const portfolio = JSON.parse(saved)
        document.getElementById('gold-amount').value = portfolio.gold || ''
        document.getElementById('silver-amount').value = portfolio.silver || ''
      }
      
      // Load crypto portfolio
      const savedCrypto = localStorage.getItem('cryptoPortfolio')
      if (savedCrypto) {
        cryptoPortfolio = JSON.parse(savedCrypto)
      }
    }
    
    function savePortfolio() {
      const portfolio = {
        gold: parseFloat(document.getElementById('gold-amount').value) || 0,
        silver: parseFloat(document.getElementById('silver-amount').value) || 0
      }
      localStorage.setItem('metalPortfolio', JSON.stringify(portfolio))
    }
    
    function saveCryptoPortfolio() {
      localStorage.setItem('cryptoPortfolio', JSON.stringify(cryptoPortfolio))
    }
    
    function updatePortfolio() {
      savePortfolio()
      
      const goldGrams = parseFloat(document.getElementById('gold-amount').value) || 0
      const silverGrams = parseFloat(document.getElementById('silver-amount').value) || 0
      
      const goldPrice = data?.prices?.gold?.pricePerGram || 0
      const silverPrice = data?.prices?.silver?.pricePerGram || 0
      
      const goldValue = goldGrams * goldPrice
      const silverValue = silverGrams * silverPrice
      
      // Calculate crypto value
      let cryptoTotalValue = 0
      cryptoPortfolio.forEach(crypto => {
        const priceData = data?.crypto?.prices?.[crypto.id]
        if (priceData) {
          cryptoTotalValue += (crypto.amount || 0) * priceData.price
        }
      })
      
      const totalValue = goldValue + silverValue + cryptoTotalValue
      
      // Update gold
      document.getElementById('gold-value').textContent = formatPrice(goldValue)
      document.getElementById('gold-detail').textContent = `${goldGrams}g √ó ${formatPrice(goldPrice)}/g`
      
      // Update silver
      document.getElementById('silver-value').textContent = formatPrice(silverValue)
      document.getElementById('silver-detail').textContent = `${silverGrams}g √ó ${formatPrice(silverPrice)}/g`
      
      // Update totals
      document.getElementById('total-value').textContent = formatPrice(totalValue)
      document.getElementById('breakdown-gold').textContent = formatPrice(goldValue)
      document.getElementById('breakdown-silver').textContent = formatPrice(silverValue)
      
      // Update breakdown with crypto if exists
      updateBreakdownWithCrypto(cryptoTotalValue)
    }
    
    function updateBreakdownWithCrypto(cryptoValue) {
      const breakdownContainer = document.querySelector('.portfolio-total-breakdown')
      
      // Remove existing crypto breakdown row
      const existingCryptoRow = document.getElementById('breakdown-crypto-row')
      if (existingCryptoRow) existingCryptoRow.remove()
      
      // Add crypto breakdown if we have crypto
      if (cryptoPortfolio.length > 0) {
        const cryptoRow = document.createElement('div')
        cryptoRow.className = 'breakdown-row'
        cryptoRow.id = 'breakdown-crypto-row'
        cryptoRow.innerHTML = `
          <span class="breakdown-label">ü™ô Crypto</span>
          <span class="breakdown-value">${formatPrice(cryptoValue)}</span>
        `
        breakdownContainer.appendChild(cryptoRow)
      }
    }
    
    // Crypto Modal functions
    function openAddCryptoModal() {
      const modal = document.getElementById('add-crypto-modal')
      const select = document.getElementById('crypto-select')
      
      // Populate dropdown with top 10 cryptos
      select.innerHTML = '<option value="">Select a cryptocurrency...</option>'
      
      if (data?.crypto?.top10) {
        data.crypto.top10.forEach(coin => {
          // Skip if already in portfolio
          if (cryptoPortfolio.some(c => c.id === coin.id)) return
          
          const option = document.createElement('option')
          option.value = coin.id
          option.textContent = `${coin.name} (${coin.symbol}) - ${formatPrice(coin.price)}`
          option.dataset.symbol = coin.symbol
          option.dataset.name = coin.name
          option.dataset.image = coin.image
          select.appendChild(option)
        })
      }
      
      modal.classList.add('active')
    }
    
    function closeAddCryptoModal() {
      document.getElementById('add-crypto-modal').classList.remove('active')
    }
    
    function addSelectedCrypto() {
      const select = document.getElementById('crypto-select')
      const selectedOption = select.options[select.selectedIndex]
      
      if (!select.value) return
      
      cryptoPortfolio.push({
        id: select.value,
        symbol: selectedOption.dataset.symbol,
        name: selectedOption.dataset.name,
        image: selectedOption.dataset.image,
        amount: 0
      })
      
      saveCryptoPortfolio()
      renderCryptoPortfolio()
      closeAddCryptoModal()
      updatePortfolio()
    }
    
    function removeCrypto(id) {
      cryptoPortfolio = cryptoPortfolio.filter(c => c.id !== id)
      saveCryptoPortfolio()
      renderCryptoPortfolio()
      updatePortfolio()
    }
    
    function updateCryptoAmount(id, amount) {
      const crypto = cryptoPortfolio.find(c => c.id === id)
      if (crypto) {
        crypto.amount = parseFloat(amount) || 0
        saveCryptoPortfolio()
        updateCryptoCardValue(id)
        updatePortfolio()
      }
    }
    
    function updateCryptoCardValue(id) {
      const crypto = cryptoPortfolio.find(c => c.id === id)
      const priceData = data?.crypto?.prices?.[id]
      
      if (crypto && priceData) {
        const value = crypto.amount * priceData.price
        const valueEl = document.getElementById(`crypto-value-${id}`)
        if (valueEl) {
          valueEl.textContent = `= ${formatPrice(value)}`
        }
      }
    }
    
    function renderCryptoPortfolio() {
      const container = document.getElementById('crypto-portfolio')
      
      if (cryptoPortfolio.length === 0) {
        container.innerHTML = `
          <div style="color: #71717a; padding: 20px; text-align: center;">
            No crypto added yet. Click "Add Crypto" to start.
          </div>
        `
        return
      }
      
      container.innerHTML = cryptoPortfolio.map(crypto => {
        const priceData = data?.crypto?.prices?.[crypto.id]
        const price = priceData?.price || 0
        const change = priceData?.changePercent24h || 0
        const changeClass = change >= 0 ? 'up' : 'down'
        const changeSign = change >= 0 ? '+' : ''
        const value = (crypto.amount || 0) * price
        
        return `
          <div class="crypto-card">
            <button class="remove-crypto-btn" onclick="removeCrypto('${crypto.id}')" title="Remove">‚úï</button>
            <div class="crypto-card-header">
              <img class="crypto-icon" src="${crypto.image || ''}" alt="${crypto.symbol}" onerror="this.style.display='none'">
              <div>
                <div class="crypto-name">${crypto.name}</div>
                <div class="crypto-symbol">${crypto.symbol}</div>
              </div>
            </div>
            <div class="crypto-price">${formatPrice(price)}</div>
            <div class="crypto-change ${changeClass}">${changeSign}${change.toFixed(2)}% (24h)</div>
            <div class="crypto-input-row">
              <input type="number" class="crypto-input" 
                     value="${crypto.amount || ''}" 
                     placeholder="0"
                     min="0" 
                     step="0.0001"
                     onchange="updateCryptoAmount('${crypto.id}', this.value)"
                     oninput="updateCryptoAmount('${crypto.id}', this.value)">
              <span style="color: #a1a1aa; font-size: 0.85rem;">${crypto.symbol}</span>
            </div>
            <div class="crypto-value" id="crypto-value-${crypto.id}">= ${formatPrice(value)}</div>
          </div>
        `
      }).join('')
    }
    
    async function fetchData() {
      try {
        const res = await fetch('/api/dashboard')
        data = await res.json()
        render()
      } catch (e) {
        console.error('Failed to fetch data:', e)
      }
    }
    
    async function refreshData() {
      document.querySelector('.refresh-btn').textContent = '‚è≥ Refreshing...'
      await fetch('/api/refresh', { method: 'POST' })
      await fetchData()
      document.querySelector('.refresh-btn').textContent = 'üîÑ Refresh'
    }
    
    function formatPrice(price) {
      return new Intl.NumberFormat('nl-NL', { 
        style: 'currency', 
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(price)
    }
    
    function formatChange(change, percent) {
      if (change === null || change === undefined) return { text: '‚Äî', class: 'neutral' }
      const sign = change >= 0 ? '+' : ''
      const cls = change > 0 ? 'up' : change < 0 ? 'down' : 'neutral'
      const percentText = percent !== null ? ` (${sign}${percent.toFixed(2)}%)` : ''
      return { text: `${sign}${formatPrice(change)}${percentText}`, class: cls }
    }
    
    function renderChart(history, metalClass) {
      if (!history || history.length < 2) return ''
      
      const prices = history.map(h => h.price)
      const min = Math.min(...prices)
      const max = Math.max(...prices)
      const range = max - min || 1
      
      const bars = prices.map(p => {
        const height = ((p - min) / range) * 100
        return `<div class="chart-bar" style="height: ${Math.max(10, height)}%"></div>`
      }).join('')
      
      return `<div class="chart-container ${metalClass}">${bars}</div>`
    }
    
    function renderMetal(metal, metalData, advice, history, icon, name) {
      if (!metalData) return `<div class="card metal-card ${metal}"><div class="loading">No data available</div></div>`
      
      const change = formatChange(metalData.change24h, metalData.changePercent24h)
      const adviceClass = advice.advice.toLowerCase()
      
      return `
        <div class="card metal-card ${metal}">
          <div class="metal-header">
            <div>
              <div class="metal-icon">${icon}</div>
              <div class="metal-name">${name}</div>
            </div>
            <span class="change ${change.class}">${change.text}</span>
          </div>
          
          <div class="price-main">${formatPrice(metalData.price)}</div>
          <div class="price-sub">per troy ounce ¬∑ ${formatPrice(metalData.pricePerGram)}/gram</div>
          
          ${renderChart(history, metal)}
          
          <div class="advice-box ${adviceClass}">
            <div class="advice-label">${advice.advice}</div>
            <div class="confidence">Confidence: ${advice.confidence}%</div>
            <div class="confidence-bar">
              <div class="confidence-fill" style="width: ${advice.confidence}%"></div>
            </div>
            <ul class="reasons">
              ${advice.reasons.map(r => `<li>${r}</li>`).join('')}
            </ul>
          </div>
        </div>
      `
    }
    
    function renderNews(newsItems, metal) {
      if (!newsItems || newsItems.length === 0) return ''
      
      return newsItems.slice(0, 3).map(item => `
        <div class="news-item">
          <a href="${item.url || '#'}" target="_blank" rel="noopener">
            <div class="news-title">${item.title}</div>
            <div class="news-meta">
              <span>${item.source || 'News'}</span>
              <span>${item.publishedAt ? new Date(item.publishedAt).toLocaleDateString('nl-NL') : ''}</span>
            </div>
          </a>
        </div>
      `).join('')
    }
    
    function render() {
      if (!data) return
      
      // Update timestamp
      document.getElementById('last-update').textContent = 
        `Last update: ${data.prices.lastUpdate ? new Date(data.prices.lastUpdate).toLocaleString('nl-NL') : 'Unknown'}`
      
      // Update portfolio values with new prices
      updatePortfolio()
      
      // Render prices
      document.getElementById('prices').innerHTML = `
        ${renderMetal('gold', data.prices.gold, data.advice.gold, data.history.gold, 'ü•á', 'Gold (XAU)')}
        ${renderMetal('silver', data.prices.silver, data.advice.silver, data.history.silver, 'ü•à', 'Silver (XAG)')}
      `
      
      // Render news
      document.getElementById('news').innerHTML = `
        <div>
          <h3 style="font-size: 1rem; color: #fbbf24; margin-bottom: 12px;">ü•á Gold News</h3>
          ${renderNews(data.news.gold, 'gold')}
        </div>
        <div>
          <h3 style="font-size: 1rem; color: #94a3b8; margin-bottom: 12px;">ü•à Silver News</h3>
          ${renderNews(data.news.silver, 'silver')}
        </div>
      `
      
      // Render crypto portfolio
      renderCryptoPortfolio()
    }
    
    // Initial load
    loadPortfolio()
    fetchData()
    
    // Auto-refresh every 5 minutes
    setInterval(fetchData, 5 * 60 * 1000)
    
    // Update portfolio on input (also handles Enter key)
    document.getElementById('gold-amount').addEventListener('input', updatePortfolio)
    document.getElementById('silver-amount').addEventListener('input', updatePortfolio)
    
    // Close modal on outside click
    document.getElementById('add-crypto-modal').addEventListener('click', function(e) {
      if (e.target === this) closeAddCryptoModal()
    })
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeAddCryptoModal()
    })
  </script>
</body>
</html>
